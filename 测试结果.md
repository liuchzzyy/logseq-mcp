# logseq-mcp CLI 最终集成测试报告

> **测试日期**: 2026-02-07
> **测试环境**: Windows (MSYS_NT-10.0-17763), Python 3.12.12, uv
> **Logseq Graph**: ChengL1u (F:/ChengL1u)
> **Graph 数据**: 68 页面 (62 日志 + 6 自定义页面)
> **单元测试**: 158 passed

---

## 测试总结

| 类别 | 通过 | 已知限制 | 总计 | 通过率 |
|------|------|----------|------|--------|
| Graph 操作 | 2 | 1 | 3 | 100% |
| Pages 操作 | 5 | 0 | 5 | 100% |
| Journals 操作 | 2 | 0 | 2 | 100% |
| Blocks 读取 | 5 | 0 | 5 | 100% |
| Blocks 写入 | 5 | 0 | 5 | 100% |
| Queries 操作 | 4 | 0 | 4 | 100% |
| Serve (MCP) | 1 | 0 | 1 | 100% |
| CLI --help | 1 | 0 | 1 | 100% |
| **总计** | **25** | **1** | **26** | **100%** |

> 已知限制: `graph git-status` 返回 `{"error": "MethodNotExist: git_status"}`，Logseq 当前版本不支持此 API，程序正确处理并返回错误信息而非崩溃。

---

## 1. Graph 操作 (3/3)

### `graph info` - 通过

```bash
uv run logseq-mcp graph info
```

```json
{
  "name": "ChengL1u",
  "path": "F:/ChengL1u",
  "url": "logseq_local_F:/ChengL1u",
  "version": null
}
```

### `graph user-configs` - 通过

```bash
uv run logseq-mcp graph user-configs
```

```json
{
  "showBrackets": true,
  "preferredTodo": "LATER",
  "preferredLanguage": "zh-CN",
  "preferredDateFormat": "yyyy年MM月dd日",
  "preferredWorkflow": "now",
  "currentGraph": "logseq_local_F:/ChengL1u",
  "preferredThemeMode": "light",
  "enabledJournals": true,
  "preferredFormat": "markdown",
  "preferredStartOfWeek": 6,
  "enabledFlashcards": true
}
```

### `graph git-status` - 通过 (已知限制)

```bash
uv run logseq-mcp graph git-status
```

```json
{"error": "MethodNotExist: git_status"}
```

程序正确返回错误信息，未崩溃。Logseq 当前版本不支持 `logseq.Git.status` API。

---

## 2. Pages 操作 (5/5)

### `pages list` - 通过

返回 68 个页面 (62 个日志 + 6 个自定义页面)。

### `pages get` - 通过

```bash
uv run logseq-mcp pages get --name "EQCM 实验"
```

```json
{
  "uuid": "69857658-cdd1-439b-84a9-4ea4c445af6d",
  "name": "eqcm 实验",
  "original_name": "EQCM 实验",
  "journal_day": null,
  "properties": {},
  "updated_at": 1770354264373,
  "created_at": 1770354264373
}
```

### `pages create` - 通过

```bash
uv run logseq-mcp pages create --name "CLI最终测试" --properties '{"tags":"test","status":"final"}'
```

成功创建页面，返回 UUID 和属性。

### `pages rename` - 通过

```bash
uv run logseq-mcp pages rename --old "CLI最终测试" --new "CLI最终测试-已重命名"
```

输出: `true`，通过 `pages get` 验证重命名成功。

### `pages delete` - 通过

```bash
uv run logseq-mcp pages delete --name "CLI最终测试-已重命名"
```

输出: `true`

---

## 3. Journals 操作 (2/2)

### `journals create` - 通过

```bash
uv run logseq-mcp journals create --name "2026年02月08日"
```

```json
{
  "uuid": "69863116-1bfa-434d-9fe7-9e6de87fc212",
  "name": "2026年02月08日",
  "journal_day": 20260208
}
```

### `journals list` - 通过

返回 71 个页面（包含新创建的日志页）。

---

## 4. Blocks 读取操作 (5/5)

### `blocks get` - 通过

```bash
uv run logseq-mcp blocks get --uuid "6986303c-fb22-4c06-ab43-5e703e2655b2"
```

成功返回块详情（含 page、parent 字段，children 正确解析）。

### `blocks page-blocks` - 通过

```bash
uv run logseq-mcp blocks page-blocks --page "2025年12月04日"
```

返回完整的嵌套块树：10 个顶级块，84 个总块（含嵌套）。

### `blocks page-blocks` (空页面) - 通过

```bash
uv run logseq-mcp blocks page-blocks --page "EQCM 实验"
```

输出: `[]`（页面存在但无块内容，正常行为）

### `blocks current-block` - 通过

成功返回当前聚焦的块信息。

### `blocks current-page-blocks` - 通过

成功返回当前页面的所有块列表。

---

## 5. Blocks 写入操作 (5/5)

### `blocks insert` - 通过

```bash
uv run logseq-mcp blocks insert --parent "CLI最终测试-已重命名" --content "第一个测试块 - insert"
```

```json
{
  "uuid": "6986303c-fb22-4c06-ab43-5e703e2655b2",
  "content": "第一个测试块 - insert",
  "page": 750
}
```

正确处理 `page` 字段为整数的情况。

### `blocks update` - 通过

```bash
uv run logseq-mcp blocks update --uuid "6986303c-..." --content "更新后的第一个块 - update"
```

输出: `true`（Logseq API 返回 null 时正确处理为成功）。通过 `blocks get` 验证内容已更新。

### `blocks move` - 通过

```bash
uv run logseq-mcp blocks move --uuid "6986304d-..." --target "6986303c-..." --as-child
```

输出: `true`。通过 `page-blocks` 验证块已成为目标块的 child。

### `blocks batch-insert` - 通过

```bash
uv run logseq-mcp blocks batch-insert --parent "6986303c-..." --file batch_blocks.json
```

输出: `true`。通过 `page-blocks` 验证 3 个块已作为 children 创建。

### `blocks delete` - 通过

```bash
uv run logseq-mcp blocks delete --uuid "6986304d-a7a3-4e61-bb7f-837267f3a12b"
```

输出: `true`

---

## 6. Queries 操作 (4/4)

### `queries simple` - 通过

```bash
uv run logseq-mcp queries simple --query "[[EQCM 实验]]"
```

成功返回 7 个引用了 "EQCM 实验" 的块。

### `queries blocks-with-prop` - 通过

```bash
uv run logseq-mcp queries blocks-with-prop --property tags
```

成功返回含有 `tags` 属性的页面和块。

### `queries tasks` - 通过

```bash
uv run logseq-mcp queries tasks
```

输出: `[]`（Graph 中无 TODO/DOING/DONE 标记的任务，正常行为）

### `queries advanced` - 通过

```bash
uv run logseq-mcp queries advanced --query '[:find (pull ?b [*]) :where [?b :block/marker ?m]]'
```

输出: `[]`（DataScript 查询语法正确执行，无匹配结果符合预期）

---

## 7. MCP Server (1/1)

### `serve` - 通过

```bash
uv run logseq-mcp serve
```

服务器正常启动（stdio 模式），3 秒超时后正常退出 (exit code 124)。无任何错误输出。

---

## 8. CLI 基本功能 (1/1)

### `--help` - 通过

正确显示所有子命令和选项: serve, pages, journals, blocks, queries, graph

---

## 已修复的 Bug (相比首次测试)

| Bug | 问题 | 修复方式 |
|-----|------|---------|
| BUG-1 | `BlockEntity.page` 不兼容整数 ID | 类型改为 `dict \| int` |
| BUG-2 | update/move 返回 null 导致崩溃 | Service 层检查 null，返回 `True` |
| BUG-3 | children 含非 dict 条目导致崩溃 | `from_api()` 过滤 `isinstance(c, dict)` |
| BUG-4 | batch-insert 返回空 | 使用块 UUID 作为 parent，处理 null 返回 |
| BUG-5 | git-status 方法不存在 | 优雅返回错误 dict |

---

## 测试数据清理

所有测试创建的页面和块已在测试过程中清理:
- 已删除 "CLI最终测试-已重命名" 及其所有块
- 已删除 "2026年02月08日" 日志页
