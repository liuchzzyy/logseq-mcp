# logseq-mcp CLI 集成测试报告

> **测试日期**: 2026-02-07
> **测试环境**: Windows (MSYS_NT-10.0-17763), Python 3.12.12, uv
> **Logseq Graph**: ChengL1u (F:/ChengL1u)
> **Graph 数据**: 68 页面 (62 日志 + 6 自定义页面)

---

## 测试总结

| 类别 | 通过 | 失败 | 总计 | 通过率 |
|------|------|------|------|--------|
| Graph 操作 | 2 | 1 | 3 | 67% |
| Pages 操作 | 5 | 0 | 5 | 100% |
| Journals 操作 | 2 | 0 | 2 | 100% |
| Blocks 读取 | 3 | 2 | 5 | 60% |
| Blocks 写入 | 2 | 3 | 5 | 40% |
| Queries 操作 | 3 | 1 | 4 | 75% |
| Serve (MCP) | 1 | 0 | 1 | 100% |
| CLI --help | 1 | 0 | 1 | 100% |
| **总计** | **19** | **7** | **26** | **73%** |

---

## 1. Graph 操作

### `graph info` - 通过

```bash
uv run logseq-mcp graph info
```

```json
{
  "name": "ChengL1u",
  "path": "F:/ChengL1u",
  "url": "logseq_local_F:/ChengL1u",
  "version": null
}
```

### `graph user-configs` - 通过

```bash
uv run logseq-mcp graph user-configs
```

```json
{
  "showBrackets": true,
  "preferredTodo": "LATER",
  "preferredLanguage": "zh-CN",
  "preferredDateFormat": "yyyy年MM月dd日",
  "preferredWorkflow": "now",
  "currentGraph": "logseq_local_F:/ChengL1u",
  "preferredThemeMode": "light",
  "enabledJournals": true,
  "preferredFormat": "markdown",
  "preferredStartOfWeek": 6,
  "enabledFlashcards": true
}
```

### `graph git-status` - 失败

```bash
uv run logseq-mcp graph git-status
```

```json
{"error": "MethodNotExist: git_status"}
```

**原因**: Logseq 当前版本不支持 `logseq.Git.status` API 方法。

---

## 2. Pages 操作

### `pages list` - 通过

```bash
uv run logseq-mcp pages list
```

返回 68 个页面 (62 个日志 + 6 个自定义页面)。

自定义页面:
- card
- contents
- eqcm 实验
- favorites
- mspd 的实验
- 第二篇文章

### `pages get` - 通过

```bash
uv run logseq-mcp pages get --name "EQCM 实验"
```

```json
{
  "uuid": "69857658-cdd1-439b-84a9-4ea4c445af6d",
  "name": "eqcm 实验",
  "original_name": "EQCM 实验",
  "journal_day": null,
  "properties": {},
  "updated_at": 1770354264373,
  "created_at": 1770354264373
}
```

### `pages create` - 通过

```bash
uv run logseq-mcp pages create --name "MCP测试页面" --properties '{"tags":"test,mcp","status":"testing"}'
```

```json
{
  "uuid": "698621e4-4000-43db-a9b4-2e23b03cb03f",
  "name": "mcp测试页面",
  "original_name": "MCP测试页面",
  "properties": {"tags": "test,mcp", "status": "testing"}
}
```

### `pages rename` - 通过

```bash
uv run logseq-mcp pages rename --old "MCP测试页面" --new "MCP测试页面-已重命名"
```

输出: `true`

验证重命名成功:

```json
{
  "name": "mcp测试页面-已重命名",
  "original_name": "MCP测试页面-已重命名"
}
```

### `pages delete` - 通过

```bash
uv run logseq-mcp pages delete --name "MCP测试页面-已重命名"
```

输出: `true`

---

## 3. Journals 操作

### `journals create` - 通过

```bash
uv run logseq-mcp journals create --name "2026年02月08日"
```

```json
{
  "uuid": "698622cb-614d-408b-bfea-0e934f6ca771",
  "name": "2026年02月08日",
  "journal_day": 20260208
}
```

### `journals list` - 通过

```bash
uv run logseq-mcp journals list
```

返回 71 个页面（包含新创建的日志页）。已清理测试数据。

---

## 4. Blocks 读取操作

### `blocks page-blocks` - 通过

```bash
uv run logseq-mcp blocks page-blocks --page "2025年12月04日"
```

成功返回完整的块树结构，包含嵌套的 children。示例内容:
- MISTRAL 实验 (4 children)
  - "将过夜的 EMD 继续循环测试，Bulk Cell 相同的环境"
  - "没有看出明显的变化，然后需要放到烘箱烘干，继续测试"
  - "晚上继续在原溶液中进行测试"
  - "结论是，在这个0.5M + 0.2M + bufferedLC solution + pH@4.2 Bulk Cell 中没有影响"
- CLAESS 实验 (children with nested data)
- [[EQCM 实验]] (children with detailed steps)

```bash
uv run logseq-mcp blocks page-blocks --page "2025年12月10日"
```

返回内容:
- [[EQCM 实验]]
- "整理完每台电脑上的数据"
- [[MSPD 的实验]] → "制备两种 EMD，用不锈钢大量沉积"

### `blocks current-block` - 通过

```bash
uv run logseq-mcp blocks current-block
```

```json
{
  "uuid": "69861c3f-4f2e-4e03-b9ce-7bc5f3f76cf5",
  "content": "",
  "children": [],
  "properties": {}
}
```

### `blocks current-page-blocks` - 通过

```bash
uv run logseq-mcp blocks current-page-blocks
```

成功返回当前页面（MCP测试页面）的所有块列表。

### `blocks get` - 失败

```bash
uv run logseq-mcp blocks get --uuid "69857658-7e27-4f84-9585-2dbc4de0df03"
```

**错误**: `AttributeError: 'list' object has no attribute 'get'`

**原因**: `BlockEntity.from_api()` 中 children 解析逻辑问题 — Logseq API 返回的 children 包含 `[["uuid", "xxx"]]` 格式的列表而非字典，`from_api()` 未处理此情况。

### `blocks page-blocks` (空页面) - 通过

```bash
uv run logseq-mcp blocks page-blocks --page "EQCM 实验"
```

输出: `[]`（页面存在但无块内容，正常行为）

---

## 5. Blocks 写入操作

### `blocks insert` - 失败 (API 成功, 解析失败)

```bash
uv run logseq-mcp blocks insert --parent "MCP测试页面" --content "第一个测试块"
```

**错误**: `pydantic_core._pydantic_core.ValidationError: page - Input should be a valid dictionary, input_value=733, input_type=int`

**原因**: Logseq API 的 `insertBlock` 返回的 `page` 字段为整数 ID (`733`)，而 `BlockEntity` 模型期望字典 (`{"id": 733}`)。

**注意**: 虽然 CLI 报错，但块实际已成功插入到 Logseq 中（通过 `current-page-blocks` 验证）。

### `blocks update` - 失败 (API 成功, 解析失败)

```bash
uv run logseq-mcp blocks update --uuid "6986220d-..." --content "更新后的内容"
```

**错误**: `AttributeError: 'NoneType' object has no attribute 'get'`

**原因**: Logseq API 的 `updateBlock` 返回 `null`，`BlockEntity.from_api()` 未处理 None 返回值。

### `blocks delete` - 通过

```bash
uv run logseq-mcp blocks delete --uuid "6986220d-8e56-46bf-83b6-d3a5fd1cfa20"
```

输出: `true`

### `blocks move` - 失败 (API 成功, 解析失败)

```bash
uv run logseq-mcp blocks move --uuid "698621f8-..." --target "698621e4-..." --as-child
```

**错误**: `AttributeError: 'NoneType' object has no attribute 'get'`

**原因**: 同 `blocks update`，Logseq API 的 `moveBlock` 返回 `null`。

### `blocks batch-insert` - 失败

```bash
uv run logseq-mcp blocks batch-insert --parent "批量测试页" --file blocks.json
```

输出: `[]`（空数组）

**原因**: batch insert API 调用返回空结果，块未被创建。可能是 API 参数格式不匹配。

---

## 6. Queries 操作

### `queries simple` - 通过

```bash
uv run logseq-mcp queries simple --query "[[EQCM 实验]]"
```

成功返回 7 个引用了 "EQCM 实验" 的块，包括:
- "Coin Cell 在有限电解液的特征做"
- "[[EQCM 实验]]" (引用块本身)
- "清洗Pt电极"
- "EMD 特征"
- "Coin Cell 的特征测试"
- 实验步骤详细说明
- 另一个日志页的引用

```bash
uv run logseq-mcp queries simple --query "[[MSPD 的实验]]"
```

返回 2 个块: 引用块和 "制备两种 EMD，用不锈钢大量沉积"。

### `queries blocks-with-prop` - 通过

```bash
uv run logseq-mcp queries blocks-with-prop --property tags
```

成功返回含有 `tags` 属性的页面和块（如 MCP测试页面 的 properties block）。

### `queries tasks` - 通过

```bash
uv run logseq-mcp queries tasks
```

输出: `[]`（Graph 中无 TODO/DOING/DONE 标记的任务，正常行为）

### `queries advanced` - 失败

```bash
uv run logseq-mcp queries advanced --query '[:find (pull ?b [*]) :where [?b :block/marker ?m]]'
```

输出: `[]`（同上，无 marker 块，但 DataScript 查询语法已正确执行）

**注**: 严格来说这不算失败（查询正确执行但无匹配结果），标记为通过更合理。但由于无法在此环境验证非空结果，保守标记。

---

## 7. MCP Server

### `serve` - 通过

```bash
uv run logseq-mcp serve
```

服务器正常启动（stdio 模式），3 秒超时后正常退出 (exit code 124)。无任何错误输出。

---

## 8. CLI 基本功能

### `--help` - 通过

```bash
uv run logseq-mcp --help
```

正确显示所有子命令和选项:
- serve, pages, journals, blocks, queries, graph
- --api-key, --url 全局选项

---

## 已发现的 Bug

### BUG-1: `BlockEntity.from_api()` 不兼容 Logseq API 的 `page` 字段格式

**影响**: `blocks insert`, `blocks get` (部分场景)
**现象**: `page` 字段期望 `dict` 类型，但 Logseq `insertBlock` API 返回整数 ID
**建议修复**: `BlockEntity.page` 类型改为 `dict | int`，或在 `from_api()` 中做兼容处理

### BUG-2: `BlockEntity.from_api()` 未处理 None 返回值

**影响**: `blocks update`, `blocks move`
**现象**: Logseq API 对 update/move 操作返回 `null`，`from_api(None)` 导致 AttributeError
**建议修复**: Service 层在调用 `from_api()` 前检查返回值是否为 None，返回成功消息即可

### BUG-3: `BlockEntity.from_api()` children 解析异常

**影响**: `blocks get` (带 children 的块)
**现象**: children 中包含 `[["uuid", "xxx"]]` 格式的列表，`from_api()` 尝试对 list 调用 `.get()`
**建议修复**: `from_api()` 中增加类型检查，跳过非 dict 类型的 children 条目

### BUG-4: `batch-insert` 无效果

**影响**: `blocks batch-insert`
**现象**: API 调用成功但返回空数组，块未被创建
**建议修复**: 检查 `insertBatchBlock` 的参数格式是否与 Logseq API 匹配

### BUG-5: `graph git-status` 方法不存在

**影响**: `graph git-status`
**现象**: `MethodNotExist: git_status`
**建议修复**: 可能是 Logseq 版本不支持此 API，或方法名不正确

---

## 测试数据清理

所有测试创建的页面和块已在测试过程中清理:
- 已删除 "MCP测试页面-已重命名"
- 已删除 "2026年02月08日" 日志页
- 已删除 "批量测试页"
- 已删除相关测试块
